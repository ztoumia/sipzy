name: Build and Deploy to Docker Hub

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'backoffice/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'backoffice/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (backend, frontend, backoffice, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - backoffice

# Required permissions for paths-filter and GitHub API access
permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_USERNAME }}
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/sipzy-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/sipzy-frontend
  BACKOFFICE_IMAGE: ${{ secrets.DOCKER_USERNAME }}/sipzy-backoffice

jobs:
  # ========================================
  # Job: Detect Changes
  # ========================================
  detect-changes:
    name: Detect Changed Services
    runs-on: self-hosted
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      backoffice: ${{ steps.filter.outputs.backoffice }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/deploy.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/deploy.yml'
            backoffice:
              - 'backoffice/**'
              - '.github/workflows/deploy.yml'

      - name: Display detection results
        run: |
          echo "Backend changed: ${{ steps.filter.outputs.backend }}"
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Backoffice changed: ${{ steps.filter.outputs.backoffice }}"
          echo "Manual trigger service: ${{ github.event.inputs.service }}"

  # ========================================
  # Job: Build and Push Backend
  # ========================================
  build-backend:
    name: Build and Push Backend
    runs-on: self-hosted
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      github.event.inputs.service == 'backend' ||
      github.event.inputs.service == 'all'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            GRADLE_BUILD_ARGS=--no-daemon

      - name: Image digest
        run: echo "Backend image digest ${{ steps.meta.outputs.digest }}"

  # ========================================
  # Job: Build and Push Frontend
  # ========================================
  build-frontend:
    name: Build and Push Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend == 'true' ||
      github.event.inputs.service == 'frontend' ||
      github.event.inputs.service == 'all'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          build-contexts: |
            shared=./shared
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}

      - name: Image digest
        run: echo "Frontend image digest ${{ steps.meta.outputs.digest }}"

  # ========================================
  # Job: Build and Push Backoffice
  # ========================================
  build-backoffice:
    name: Build and Push Backoffice
    runs-on: self-hosted
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backoffice == 'true' ||
      github.event.inputs.service == 'backoffice' ||
      github.event.inputs.service == 'all'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKOFFICE_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backoffice
        uses: docker/build-push-action@v5
        with:
          context: ./backoffice
          file: ./backoffice/Dockerfile
          build-contexts: |
            shared=./shared
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.BACKOFFICE_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKOFFICE_IMAGE }}:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}

      - name: Image digest
        run: echo "Backoffice image digest ${{ steps.meta.outputs.digest }}"

  # ========================================
  # Job: Security Scan
  # ========================================
  security-scan:
    name: Security Scan
    runs-on: self-hosted
    needs: [build-backend, build-frontend, build-backoffice]
    if: always() && (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success' || needs.build-backoffice.result == 'success')
    strategy:
      matrix:
        image:
          - ${{ needs.build-backend.result == 'success' && 'backend' || '' }}
          - ${{ needs.build-frontend.result == 'success' && 'frontend' || '' }}
          - ${{ needs.build-backoffice.result == 'success' && 'backoffice' || '' }}
        exclude:
          - image: ''
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/sipzy-${{ matrix.image }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.image }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.image }}.sarif'
          category: trivy-${{ matrix.image }}

  # ========================================
  # Job: Deployment Summary
  # ========================================
  deployment-summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [build-backend, build-frontend, build-backoffice]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            echo "| Backend | âœ… Success | \`${{ env.BACKEND_IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-backend.result }}" == "skipped" ]; then
            echo "| Backend | â­ï¸ Skipped | No changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-backoffice.result }}" == "success" ]; then
            echo "| Backoffice | âœ… Success | \`${{ env.BACKOFFICE_IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-backoffice.result }}" == "skipped" ]; then
            echo "| Backoffice | â­ï¸ Skipped | No changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backoffice | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-backoffice.result }}" == "success" ]; then
            echo "| Backoffice | âœ… Success | \`${{ env.BACKOFFICE_IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-backoffice.result }}" == "skipped" ]; then
            echo "| Backoffice | â­ï¸ Skipped | No changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backoffice | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
